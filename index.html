<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Attendance Viewer: Department of Mathematics</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background-color: lightyellow;
    }
    .container {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    main {
      flex: 1;
      padding: 20px;
    }
    select, button, input {
      margin-top: 10px;
      padding: 8px;
    }
    #result, #detailReport {
      margin-top: 20px;
      padding: 15px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    h1 {
      color: limegreen;
      text-align: center;
      margin-bottom: 5px;
    }
    h2 {
      color: orangered;
    }
    .button {
      margin-top: 10px;
      padding: 15px;
      background-color: blanchedalmond;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    footer {
      background-color: #333;
      color: white;
      text-align: center;
      padding: 12px;
    }
    .red-text {
      color: red;
      font-weight: bold;
    }
    .green-text {
      color: green;
      font-weight: bold;
    }
    .yellow-text {
      color: #FF8C00;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    .attendance-options {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .attendance-option {
      padding: 8px 12px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      min-width: 80px;
      text-align: center;
    }
    .attendance-option.selected {
      background-color: #4CAF50;
      color: white;
    }
    .date-input-container {
      margin-top: 10px;
    }
    .date-input-fields {
      display: flex;
      gap: 10px;
    }
    .date-input-fields select, .date-input-fields input {
      flex: 1;
    }
    #attendanceDurationInfo {
      margin-bottom: 10px;
      padding: 8px;
      background: #f8f8f8;
      border-radius: 4px;
    }
    #attendanceMessage {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <main>
      <h1>Department of Mathematics</h1>
      <h1>A.P.C. Roy Govt. College</h1>

      <div class="button">
        <div id="studentSection">
          <label for="courseSelect">Select subject:</label><br>
          <select id="courseSelect">
            <option value="">-- Select a course --</option>
          </select><br><br>

          <label for="studentSelect">Select your name:</label><br>
          <select id="studentSelect">
            <option value="">-- Select a student --</option>
          </select>
        </div>
      </div>

      <div id="result"></div>
      <div id="detailReport"></div>

      <h2>Restricted Access: Faculty Use Only</h2>

      <div style="border: 2px solid blue;" class="button">
        <div id="authSection">
          <label for="adminId">Enter ID:</label><br>
          <input type="text" id="adminId" placeholder="Enter ID"><br><br>
          <label for="adminPass">Enter Password:</label><br>
          <input type="password" id="adminPass" placeholder="Enter Password"><br><br>
          <button onclick="checkAuth()">Login</button>
          <p id="authMessage" style="color: red;"></p>
        </div>

        <div id="facultyCourseSelect" class="hidden">
          <label for="facultyCourseSelectDropdown">Select subject:</label><br>
          <select id="facultyCourseSelectDropdown">
            <option value="">-- Select a course --</option>
          </select><br><br>
        </div>

        <div id="semesterContainer" class="hidden">
          <label for="semesterSelect">Select Semester:</label><br>
          <select id="semesterSelect">
            <option value="">-- Select Semester --</option>
            <option>Semester I</option>
            <option>Semester II</option>
            <option>Semester III</option>
            <option>Semester IV</option>
            <option>Semester V</option>
            <option>Semester VI</option>
            <option>Semester VII</option>
            <option>Semester VIII</option>
          </select><br><br>
        </div>

        <div id="downloadContainer" class="hidden">
          <label for="fromDate">From Date:</label>
          <input type="date" id="fromDate">
          <label for="toDate">To Date:</label>
          <input type="date" id="toDate"><br><br>
          <button id="downloadBtn" onclick="downloadPDF()">Download Course Report as PDF</button>
        </div>

        <!-- Updated Attendance Submission Section -->
        <div id="attendanceSubmissionContainer" class="hidden">
          <h3>Submit Attendance</h3>
          <label for="attendanceCourseSelect">Select Course:</label><br>
          <select id="attendanceCourseSelect">
            <option value="">-- Select a course --</option>
          </select><br><br>
          
          <div id="attendanceStudentContainer" class="hidden">
            <label for="attendanceStudentSelect">Select Student:</label><br>
            <select id="attendanceStudentSelect">
              <option value="">-- Select a student --</option>
            </select><br><br>
            
            <div class="date-input-container">
              <label>Select Date:</label>
              <div class="date-input-fields">
                <select id="dateDay">
                  <option value="">Day</option>
                </select>
                <select id="dateMonth">
                  <option value="">Month</option>
                  <option value="Jan">January</option>
                  <option value="Feb">February</option>
                  <option value="Mar">March</option>
                  <option value="Apr">April</option>
                  <option value="May">May</option>
                  <option value="Jun">June</option>
                  <option value="Jul">July</option>
                  <option value="Aug">August</option>
                  <option value="Sep">September</option>
                  <option value="Oct">October</option>
                  <option value="Nov">November</option>
                  <option value="Dec">December</option>
                </select>
              </div>
            </div><br>
            
            <label for="classHours">Select Class Duration:</label><br>
            <select id="classHours">
              <option value="1">1 Hour</option>
              <option value="2">2 Hours</option>
              <option value="3">3 Hours</option>
            </select><br><br>
            
            <div id="attendanceOptionsContainer" class="hidden">
              <label>Select Attendance Status:</label><br>
              <div id="attendanceDurationInfo"></div>
              <div id="attendanceOptions" class="attendance-options"></div>
              <button id="submitAttendanceBtn" onclick="submitAttendance()" style="margin-top: 10px;">Submit Attendance</button>
              <p id="attendanceMessage"></p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>&copy; 2025, Department of Mathematics, A.P.C. Roy Govt. College</footer>
  </div>

<script>
  const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQPefTUtU2h-BLqI02ebABq7DnNQ2xYSAENEI-HQ_2B0P_WW_Tf832B02QgML3UaVejT0ln-ShYJoqs/pub?output=csv";

  // DOM Elements
  const courseSelect = document.getElementById("courseSelect");
  const facultyCourseSelectDropdown = document.getElementById("facultyCourseSelectDropdown");
  const studentSelect = document.getElementById("studentSelect");
  const resultDiv = document.getElementById("result");
  const detailReportDiv = document.getElementById("detailReport");

  const downloadContainer = document.getElementById("downloadContainer");
  const semesterContainer = document.getElementById("semesterContainer");
  const semesterSelect = document.getElementById("semesterSelect");
  const facultyCourseSelect = document.getElementById("facultyCourseSelect");
  const studentSection = document.getElementById("studentSection");

  // Attendance submission elements
  const attendanceSubmissionContainer = document.getElementById("attendanceSubmissionContainer");
  const attendanceCourseSelect = document.getElementById("attendanceCourseSelect");
  const attendanceStudentContainer = document.getElementById("attendanceStudentContainer");
  const attendanceStudentSelect = document.getElementById("attendanceStudentSelect");
  const classHoursSelect = document.getElementById("classHours");
  const attendanceOptionsContainer = document.getElementById("attendanceOptionsContainer");
  const attendanceOptions = document.getElementById("attendanceOptions");
  const submitAttendanceBtn = document.getElementById("submitAttendanceBtn");
  const attendanceMessage = document.getElementById("attendanceMessage");
  const dateDay = document.getElementById("dateDay");
  const dateMonth = document.getElementById("dateMonth");

  let semesterName = "";
  let attendanceData = {};
  let selectedAttendanceMark = "";

  // Initialize day dropdown
  function populateDayDropdown() {
    dateDay.innerHTML = '<option value="">Day</option>';
    for (let i = 1; i <= 31; i++) {
      const day = i < 10 ? `0${i}` : `${i}`;
      const option = document.createElement("option");
      option.value = day;
      option.textContent = day;
      dateDay.appendChild(option);
    }
  }

  // Process attendance marks
  function processAttendanceMarks(marks, headers) {
    let processed = [];

    for (let i = 0; i < marks.length; i++) {
      const mark = marks[i].trim();
      if (mark === '') continue;

      const date = headers[i];
      const upperMark = mark.toUpperCase();

      // Handle 3-hour class
      if (upperMark === 'PPP') {
        processed.push({ date, mark: upperMark, hours: 3, status: 'Present', presentHours: 3 });
      } 
      else if (upperMark === 'AAA') {
        processed.push({ date, mark: upperMark, hours: 3, status: 'Absent', presentHours: 0 });
      } 
      else if (['PPA', 'APP', 'PAP'].includes(upperMark)) {
        processed.push({ date, mark: upperMark, hours: 3, status: 'Partial', presentHours: 2 });
      } 
      else if (['PAA', 'APA', 'AAP'].includes(upperMark)) {
        processed.push({ date, mark: upperMark, hours: 3, status: 'Partial', presentHours: 1 });
      }

      // Handle 2-hour class
      else if (upperMark === 'PP') {
        processed.push({ date, mark: 'PP', hours: 2, status: 'Present', presentHours: 2 });
      } 
      else if (upperMark === 'AA') {
        processed.push({ date, mark: 'AA', hours: 2, status: 'Absent', presentHours: 0 });
      } 
      else if (upperMark === 'AP' || upperMark === 'PA') {
        processed.push({ date, mark: upperMark, hours: 2, status: 'Partial', presentHours: 1 });
      }

      // Handle 1-hour class
      else if (upperMark === 'P') {
        processed.push({ date, mark: 'P', hours: 1, status: 'Present', presentHours: 1 });
      } 
      else if (upperMark === 'A') {
        processed.push({ date, mark: 'A', hours: 1, status: 'Absent', presentHours: 0 });
      }
    }

    return processed;
  }

  // Fetch data from Google Sheets
  fetch(csvUrl)
    .then(res => res.text())
    .then(data => {
      const normalizedData = data.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const rows = normalizedData.trim().split("\n").map(row => {
        const temp = [];
        let inQuotes = false;
        let currentField = '';
        
        for (let i = 0; i < row.length; i++) {
          const char = row[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            temp.push(currentField);
            currentField = '';
          } else {
            currentField += char;
          }
        }
        temp.push(currentField);
        return temp;
      });
      
      const headers = rows[0].map(h => h.trim());
      const courseIndex = headers.indexOf("Course Name");

      for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const course = row[courseIndex].trim();
        const name = row[0].trim();
        const marks = row.slice(courseIndex + 1).map(m => m.trim());

        if (!attendanceData[course]) attendanceData[course] = [];

        const processedMarks = processAttendanceMarks(marks, headers.slice(courseIndex + 1));
        
        const totalHours = processedMarks.reduce((sum, m) => sum + m.hours, 0);
        const presentHours = processedMarks.reduce((sum, m) => sum + (m.presentHours || 0), 0);

        attendanceData[course].push({
          name,
          marks,
          processedMarks,
          totalHours,
          presentHours,
          headers: headers.slice(courseIndex + 1)
        });
      }

      // Populate course dropdowns
      Object.keys(attendanceData).forEach(course => {
        const opt = document.createElement("option");
        opt.value = course;
        opt.textContent = course;
        courseSelect.appendChild(opt);
        
        const facultyOpt = opt.cloneNode(true);
        facultyCourseSelectDropdown.appendChild(facultyOpt);
        
        const attendanceOpt = opt.cloneNode(true);
        attendanceCourseSelect.appendChild(attendanceOpt);
      });
    })
    .catch(error => {
      console.error("Error loading attendance data:", error);
      alert("Failed to load attendance data. Please check the CSV link.");
    });

  // When course is selected, populate students
  courseSelect.addEventListener("change", () => {
    studentSelect.innerHTML = '<option value="">-- Select a student --</option>';
    resultDiv.innerHTML = "";
    detailReportDiv.innerHTML = "";

    const selectedCourse = courseSelect.value;
    if (!selectedCourse) return;

    attendanceData[selectedCourse].forEach(student => {
      const opt = document.createElement("option");
      opt.value = student.name;
      opt.textContent = student.name;
      studentSelect.appendChild(opt);
    });
  });

  // When student is selected, show attendance
  studentSelect.addEventListener("change", () => {
    const course = courseSelect.value;
    const studentName = studentSelect.value;
    const student = attendanceData[course].find(s => s.name === studentName);
    if (!student) return;

    const percentage = student.totalHours ? ((student.presentHours / student.totalHours) * 100).toFixed(2) : "0";
    const percentageClass = percentage < 75 ? 'red-text' : 'green-text';

    resultDiv.innerHTML = `
      <h3>Attendance for ${student.name}</h3>
      <p><strong>Total Hours Held:</strong> ${student.totalHours}</p>
      <p><strong>Present Hours:</strong> ${student.presentHours}</p>
      <p><strong>Attendance Percentage:</strong> <span class="${percentageClass}">${percentage}%</span></p>
    `;

    let detailHTML = `<h4>Detailed Attendance:</h4><table>
      <tr><th>Date</th><th>Status</th><th>Duration</th><th>Hours Present</th></tr>`;
    
    student.processedMarks.forEach(entry => {
      let statusClass = '';
      if (entry.status === 'Present') statusClass = 'green-text';
      else if (entry.status === 'Absent') statusClass = 'red-text';
      else statusClass = 'yellow-text';
      
      detailHTML += `
        <tr>
          <td>${entry.date}</td>
          <td class="${statusClass}">${entry.status}</td>
          <td>${entry.hours} hour${entry.hours > 1 ? 's' : ''}</td>
          <td>${entry.presentHours || 0}</td>
        </tr>
      `;
    });
    
    detailHTML += "</table>";
    detailReportDiv.innerHTML = detailHTML;
  });

  // Faculty login
  function checkAuth() {
    const id = document.getElementById("adminId").value.trim();
    const pass = document.getElementById("adminPass").value.trim();
    const message = document.getElementById("authMessage");

    const correctId = "admin";
    const correctPass = "7699";

    if (id === correctId && pass === correctPass) {
      message.style.color = "green";
      message.textContent = "Login successful. Please select subject.";
      studentSection.classList.add("hidden");
      facultyCourseSelect.classList.remove("hidden");
      attendanceSubmissionContainer.classList.remove("hidden");
      
      document.getElementById("adminId").value = "";
      document.getElementById("adminPass").value = "";
      populateDayDropdown();

      facultyCourseSelectDropdown.addEventListener("change", () => {
        if (facultyCourseSelectDropdown.value) {
          semesterContainer.classList.remove("hidden");
        } else {
          semesterContainer.classList.add("hidden");
          downloadContainer.classList.add("hidden");
        }
      });

      semesterSelect.addEventListener("change", () => {
        semesterName = semesterSelect.value || "Semester - ?";
        if (semesterName !== "") {
          downloadContainer.classList.remove("hidden");
        } else {
          downloadContainer.classList.add("hidden");
        }
      });

      // Setup attendance course selection
      attendanceCourseSelect.addEventListener("change", () => {
        const selectedCourse = attendanceCourseSelect.value;
        attendanceStudentContainer.classList.toggle("hidden", !selectedCourse);
        attendanceOptionsContainer.classList.add("hidden");
        attendanceStudentSelect.innerHTML = '<option value="">-- Select a student --</option>';
        
        if (selectedCourse) {
          attendanceData[selectedCourse].forEach(student => {
            const opt = document.createElement("option");
            opt.value = student.name;
            opt.textContent = student.name;
            attendanceStudentSelect.appendChild(opt);
          });
        }
      });

      // Setup student selection for attendance
      attendanceStudentSelect.addEventListener("change", () => {
        const selectedStudent = attendanceStudentSelect.value;
        attendanceOptionsContainer.classList.toggle("hidden", !selectedStudent);
        
        if (selectedStudent) {
          updateAttendanceOptions();
        }
      });

      // Update attendance options when class hours change
      classHoursSelect.addEventListener("change", updateAttendanceOptions);

    } else {
      downloadContainer.classList.add("hidden");
      semesterContainer.classList.add("hidden");
      facultyCourseSelect.classList.add("hidden");
      attendanceSubmissionContainer.classList.add("hidden");
      message.style.color = "red";
      message.textContent = "Invalid ID or Password.";
    }
  }

  // Update attendance options based on selected class hours
  function updateAttendanceOptions() {
    const hours = parseInt(classHoursSelect.value);
    attendanceOptions.innerHTML = "";
    selectedAttendanceMark = "";
    
    const durationInfo = document.getElementById("attendanceDurationInfo");
    durationInfo.innerHTML = `<p>Class Duration: <strong>${hours} hour${hours > 1 ? 's' : ''}</strong></p>`;
    
    if (hours === 1) {
      createAttendanceOption("P", "Present (P)");
      createAttendanceOption("A", "Absent (A)");
    } else if (hours === 2) {
      createAttendanceOption("PP", "Present both hours (PP)");
      createAttendanceOption("PA", "Present first, Absent second (PA)");
      createAttendanceOption("AP", "Absent first, Present second (AP)");
      createAttendanceOption("AA", "Absent both hours (AA)");
    } else if (hours === 3) {
      createAttendanceOption("PPP", "Present all hours (PPP)");
      createAttendanceOption("PPA", "Present first two, Absent last (PPA)");
      createAttendanceOption("PAP", "Present first/last, Absent middle (PAP)");
      createAttendanceOption("APP", "Absent first, Present last two (APP)");
      createAttendanceOption("PAA", "Present first, Absent last two (PAA)");
      createAttendanceOption("APA", "Absent first/last, Present middle (APA)");
      createAttendanceOption("AAP", "Absent first two, Present last (AAP)");
      createAttendanceOption("AAA", "Absent all hours (AAA)");
    }
  }

  // Create an attendance option button
  function createAttendanceOption(value, label) {
    const option = document.createElement("div");
    option.className = "attendance-option";
    option.textContent = label;
    option.dataset.value = value;
    
    option.addEventListener("click", () => {
      document.querySelectorAll(".attendance-option").forEach(opt => {
        opt.classList.remove("selected");
      });
      option.classList.add("selected");
      selectedAttendanceMark = value;
    });
    
    attendanceOptions.appendChild(option);
  }

  // Get status description
  function getStatusDescription(mark) {
    const hours = mark.length;
    const presentHours = (mark.match(/P/g) || []).length;
    
    if (presentHours === hours) return "Fully Present";
    if (presentHours === 0) return "Fully Absent";
    return `Partially Present (${presentHours}/${hours} hours)`;
  }

  // Submit attendance to the sheet
  function submitAttendance() {
    const course = attendanceCourseSelect.value;
    const student = attendanceStudentSelect.value;
    const hours = classHoursSelect.value;
    const day = dateDay.value;
    const month = dateMonth.value;
    
    if (!course || !student || !selectedAttendanceMark || !day || !month) {
      attendanceMessage.style.color = "red";
      attendanceMessage.textContent = "Please complete all fields including date and attendance status.";
      return;
    }
    
    const dateString = `${day}-${month}`;
    const scriptUrl = "YOUR_WEB_APP_URL";
    
    attendanceMessage.style.color = "blue";
    attendanceMessage.innerHTML = `
      <strong>Submitting attendance:</strong><br>
      Student: ${student}<br>
      Course: ${course}<br>
      Date: ${dateString}<br>
      Status: ${getStatusDescription(selectedAttendanceMark)}
    `;
    
    const data = {
      course: course,
      student: student,
      mark: selectedAttendanceMark,
      hours: hours,
      date: dateString
    };
    
    fetch(scriptUrl, {
      method: "POST",
      body: JSON.stringify(data),
      headers: {
        "Content-Type": "application/json"
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === "success") {
        attendanceMessage.style.color = "green";
        attendanceMessage.innerHTML = `
          <strong>Attendance recorded successfully:</strong><br>
          Student: ${student}<br>
          Course: ${course}<br>
          Date: ${dateString}<br>
          Status: ${selectedAttendanceMark} (${getStatusDescription(selectedAttendanceMark)})
        `;
      } else {
        attendanceMessage.style.color = "red";
        attendanceMessage.textContent = `Error: ${data.message}`;
      }
    })
    .catch(error => {
      attendanceMessage.style.color = "red";
      attendanceMessage.textContent = "Failed to submit attendance. Please try again.";
      console.error("Error:", error);
    })
    .finally(() => {
      setTimeout(() => {
        attendanceCourseSelect.value = "";
        attendanceStudentSelect.value = "";
        classHoursSelect.value = "1";
        dateDay.value = "";
        dateMonth.value = "";
        selectedAttendanceMark = "";
        attendanceStudentContainer.classList.add("hidden");
        attendanceOptionsContainer.classList.add("hidden");
        attendanceMessage.textContent = "";
        
        document.querySelectorAll(".attendance-option").forEach(opt => {
          opt.classList.remove("selected");
        });
      }, 5000);
    });
  }

  // Download PDF report
  async function downloadPDF() {
    const selectedCourse = facultyCourseSelectDropdown.value;
    const fromDate = document.getElementById("fromDate").value;
    const toDate = document.getElementById("toDate").value;

    if (!selectedCourse || !attendanceData[selectedCourse]) {
      alert("Please select a course first.");
      return;
    }

    const from = fromDate ? new Date(fromDate) : null;
    const to = toDate ? new Date(toDate) : new Date();

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth();
    let y = 20;

    const centerText = (text, yOffset) => {
      const textWidth = doc.getTextWidth(text);
      const x = (pageWidth - textWidth) / 2;
      doc.text(text, x, yOffset);
    };

    // College header in PDF
    doc.setFontSize(12);
    centerText("DEPARTMENT OF MATHEMATICS", y); y += 7;
    centerText("ACHARYA PRAFULLA CHANDRA ROY GOVT. COLLEGE", y); y += 7;
    centerText("HIMACHAL BIHAR, MATIGARA, SILIGURI, DARJEELING, WB-734010", y); y += 7;
    centerText("Website: www.apcrgc.org", y); y += 10;

    if (from && to) {
      centerText(`ATTENDANCE REPORT FROM ${from.toLocaleDateString()} TO ${to.toLocaleDateString()}`, y);
    } else {
      const monthYear = new Date().toLocaleString('default', { month: 'long', year: 'numeric' });
      centerText(`ATTENDANCE REPORT FOR THE MONTH OF ${monthYear}`, y);
    }
    y += 7;
    centerText(semesterName || "Semester - ?", y);
    y += 15;

    doc.setFontSize(14);
    centerText(`Attendance Report - ${selectedCourse}`, y);
    y += 10;

    const monthMap = {
      Jan: 0, Feb: 1, Mar: 2, Apr: 3, May: 4, Jun: 5,
      Jul: 6, Aug: 7, Sep: 8, Oct: 9, Nov: 10, Dec: 11
    };

    const courseData = attendanceData[selectedCourse];
    const tableBody = courseData.map(student => {
      let totalHours = 0;
      let presentHours = 0;
      
      student.processedMarks.forEach(entry => {
        const dateParts = entry.date.split('-');
        if (dateParts.length !== 2) return;
        
        const day = parseInt(dateParts[0], 10);
        const month = monthMap[dateParts[1]];
        if (isNaN(day) || month === undefined) return;
        
        const entryDate = new Date();
        entryDate.setFullYear(new Date().getFullYear(), month, day);
        entryDate.setHours(0, 0, 0, 0);
        
        if ((!from || entryDate >= new Date(from.setHours(0, 0, 0, 0))) &&
            (!to || entryDate <= new Date(to.setHours(0, 0, 0, 0)))) {
          totalHours += entry.hours;
          presentHours += (entry.presentHours || 0);
        }
      });
      
      const percentage = totalHours
        ? ((presentHours / totalHours) * 100).toFixed(2) + "%"
        : "N/A (No Class)";
        
      return [student.name, `${presentHours}/${totalHours}`, percentage];
    });

    doc.autoTable({
      startY: y,
      head: [["Student Name", "Present/Total Hours", "Percentage"]],
      body: tableBody,
      theme: 'grid',
      styles: { fontSize: 10 },
      headStyles: { fillColor: [22, 160, 133] },
      margin: { left: 14, right: 14 }
    });

    const fileName = from && to
      ? `${selectedCourse}_attendance_${fromDate}_to_${toDate}.pdf`
      : `${selectedCourse}_attendance_report.pdf`;

    doc.save(fileName);
  }
</script>
</body>
</html>
